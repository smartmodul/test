function updateData(){$.ajax({url:"/updateData"}).done(function(e){$("#WATTMETER_TIME").text(e.WATTMETER_TIME);let a=parseInt(e.RUN_TIME,10);a-=3600*(s=Math.floor(a/86400))*24;let t=Math.floor(a/3600);a-=3600*t;let r=Math.floor(a/60);a-=60*r,$("#RUN_TIME").text((s<10?"0"+s:s)+":"+(t<10?"0"+t:t)+":"+(r<10?"0"+r:r)+":"+(a<10?"0"+a:a)),$("#U1").text(e.U1),$("#U2").text(e.U2),$("#U3").text(e.U3),$("#I1").text(rnd(e.I1,100,2,!0)),$("#I2").text(rnd(e.I2,100,2,!0)),$("#I3").text(rnd(e.I3,100,2,!0)),$("#P1").text(rnd(e.P1,1e3,2,!0)),$("#P2").text(rnd(e.P2,1e3,2,!0)),$("#P3").text(rnd(e.P3,1e3,2,!0)),e.A>0?($("#AC_IN").text("ON"),$("#AC_IN").css("color","#74DF00")):($("#AC_IN").text("OFF"),$("#AC_IN").css("color","#FF0000")),$("#PP1p").text(rnd(e.W1,1e3,1)),$("#PP2p").text(rnd(e.W2,1e3,1)),$("#PP3p").text(rnd(e.W3,1e3,1)),$("#E1dP").text(rnd(e.E1dP,100,1)),$("#E2dP").text(rnd(e.E2dP,100,1)),$("#E3dP").text(rnd(e.E3dP,100,1)),e.E1tP/100>1e6||e.E2tP/100>1e6||e.E3tP/100>1e6?($("#E1tP").text(rnd(e.E1tP,1e8,2)),$("#E2tP").text(rnd(e.E2tP,1e8,2)),$("#E3tP").text(rnd(e.E3tP,1e8,2)),$("#EtP").text("↓ Total E [GWh]")):e.E1tP/100>1e3||e.E2tP/100>1e3||e.E3tP/100>1e3?($("#E1tP").text(rnd(e.E1tP,1e5,2)),$("#E2tP").text(rnd(e.E2tP,1e5,2)),$("#E3tP").text(rnd(e.E3tP,1e5,2)),$("#EtP").text("↓ Total E [MWh]")):($("#E1tP").text(rnd(e.E1tP,100,1)),$("#E2tP").text(rnd(e.E2tP,100,1)),$("#E3tP").text(rnd(e.E3tP,100,1)),$("#EtP").text("↓ Total E [kWh]")),$("#Current_EP").text(rnd(e.E1dP+e.E2dP+e.E3dP,100,2)),$("#Previous_EP").text(rnd(e.EpDP,100,2)),$("#Total_EP").text(rnd(e.E1tP+e.E2tP+e.E3tP,100,0)),$("#ID").text(e.ID),hourEnergyData=e.Es,dailyEnergyData=e.D,monthlyEnergyData=e.M,powerAVGchartData=e.Pm,dotControl()})}function rnd(e,a,t,r){return 1==r?((e>32767?e-65535:e)/a).toFixed(t):(e/a).toFixed(t)}function chargingAnim(e,a){for(var t=1;t<5;t++)$(".charge"+t).css("animation-play-state",e),$(".charge"+t).css({"background-color":a})}function handleEvseAPI(e,a,t){$("#ACTUAL_CONFIG_CURRENT1").text(void 0!==e?e+" A":"COMM ERR."),$("#ACTUAL_OUTPUT_CURRENT1").text(void 0!==a?a+" A":"COMM ERR."),t<1||t>3?($("#EV_STATE1").text("COMM ERR."),chargingAnim("paused","inherit")):1==t?($("#EV_STATE1").text("UNPLUG"),chargingAnim("paused","inherit"),$(".charge1").css({"background-color":"red"})):2==t?($("#EV_STATE1").text("PLUG"),chargingAnim("paused","inherit"),$(".charge1").css({"background-color":"yellow"})):3==t&&($("#EV_STATE1").text("CHARGING"),chargingAnim("running","green"))}function dotControl(){elements=$("#dot");for(var e=0;e<elements.length;e++)"grey"==elements[e].style.color?elements[e].style.color="orange":elements[e].style.color="grey"}function getTime(){var e=new Date,a=""+(e.getMonth()+1);return[""+e.getDate(),a,e.getFullYear(),e.getHours(),e.getMinutes(),e.getSeconds()]}function loadPowerChart(){len=powerAVGchartData[0];for(var e=1;e<61-len;e++)powerGraph.config.data.datasets.forEach(function(a){a.data.push({x:Date.now()-1e3*(61-e)*60,y:0})});for(e=1;e<len;e++){var a;a=null!=powerAVGchartData[e]?powerAVGchartData[e]:0,powerGraph.config.data.datasets.forEach(function(t){t.data.push({x:Date.now()-1e3*(len-e)*60,y:a})})}powerGraph.update()}function refreshPowerChart(){len=powerAVGchartData[0],powerGraph.data.datasets.forEach(function(e){e.data.push({x:Date.now(),y:powerAVGchartData[len-1]})})}function refreshEnergyChartHourly(){len=hourEnergyData[0];for(var e=0,a=0,t=0,r=0,n=0;n<24;n++)null!=hourEnergyData[4*n+4]?(e=hourEnergyData[4*n+1],dataP=hourEnergyData[4*n+2],dataN=hourEnergyData[4*n+3],t=t+dataP-dataN,r+=1,energyBarGraph.data.labels[24-((len-1)/4-n)]=e+1<10?"0"+e+"-0"+(e+1):e+1==10?"09-10":e+"-"+(e+1),energyBarGraph.data.datasets[0].data[24-((len-1)/4-n)]=dataP,1==hourEnergyData[4*n+4]?energyBarGraph.data.datasets[0].backgroundColor[24-((len-1)/4-n)]="#72BD00":energyBarGraph.data.datasets[0].backgroundColor[24-((len-1)/4-n)]="#00BFEC",energyBarGraph.data.datasets[1].data[24-((len-1)/4-n)]=-dataN):(e<23?(e+=1,energyBarGraph.data.labels[a]=e+1<10?"0"+e+"-0"+(e+1):e+1==10?"09-10":e+"-"+(e+1),energyBarGraph.data.datasets[0].data[a]=0,energyBarGraph.data.datasets[1].data[a]=0,a++):(e=0,energyBarGraph.data.labels[a]="0"+e+"-0"+(e+1),energyBarGraph.data.datasets[0].data[a]=0,energyBarGraph.data.datasets[1].data[a]=0,a++),a>23&&(a=0));for(var d=0;d<24;d++)energyBarGraph.data.datasets[2].data[d]=(t/r).toFixed(1);energyBarGraph.update()}function refreshEnergyChartDaily(){var e=0,a=1;null!=dailyEnergyData&&(a=dailyEnergyData.length-1),days=Last31Days();for(var t=0;t<31;t++)null!=dailyEnergyData&&null!=dailyEnergyData[a-t]?(arr=dailyEnergyData[a-t].split(":"),e=arr[0],dat=JSON.parse(arr[1]),dataP=dat[0],dataN=dat[1],energyBarGraph.data.labels[30-t]=e,energyBarGraph.data.datasets[0].data[30-t]=parseFloat(dataP/100).toFixed(1),energyBarGraph.data.datasets[1].data[30-t]=-parseFloat(dataN/100).toFixed(1)):(energyBarGraph.data.labels[30-t]=days[t],energyBarGraph.data.datasets[0].data[30-t]=0,energyBarGraph.data.datasets[1].data[30-t]=0);for(var r=0;r<31;r++)energyBarGraph.data.datasets[2].data[r]=getAvgEnergy(dailyEnergyData,31);energyBarGraph.update()}function refreshEnergyChartMonthly(){var e=0,a=1;null!=monthlyEnergyData&&(a=monthlyEnergyData.length-1),days=Last12Month();for(var t=0;t<12;t++)null!=monthlyEnergyData&&null!=monthlyEnergyData[a-t]?(arr=monthlyEnergyData[a-t].split(":"),e=arr[0],dat=JSON.parse(arr[1]),dataP=dat[0],dataN=dat[1],energyBarGraph.data.labels[11-t]=e,energyBarGraph.data.datasets[0].data[11-t]=parseFloat(dataP/100).toFixed(1),energyBarGraph.data.datasets[1].data[11-t]=-parseFloat(dataN/100).toFixed(1)):(energyBarGraph.data.labels[11-t]=days[t],energyBarGraph.data.datasets[0].data[11-t]=0,energyBarGraph.data.datasets[1].data[11-t]=0);for(var r=0;r<12;r++)energyBarGraph.data.datasets[2].data[r]=getAvgEnergy(monthlyEnergyData,12);energyBarGraph.update()}function getAvgEnergy(e,a){for(var t=0,r=0,n=0;n<a;n++)null!=e&&null!=e[n]&&(arr=e[n].split(":"),dat=JSON.parse(arr[1]),dataP=dat[0],dataN=dat[1],t=t+parseFloat(dataP/100)-parseFloat(dataN/100),r++);return(t/r).toFixed(1)}function Last31Days(){for(var e=[],a=1;a<32;a++){var t=new Date;t.setDate(t.getDate()-a),e.push(formatDate(t))}return e}function Last12Month(){var e=new Date,a=[];for(i=0;i<=11;i++)a.push(e.getMonth()+1+"/"+e.getFullYear().toString().substr(-2)),e.setMonth(e.getMonth()-1);return a}function formatDate(e){var a=e.getDate(),t=e.getMonth()+1;return a<10&&(a="0"+a),t<10&&(t="0"+t),(t+"/"+a+"/"+e.getFullYear().toString().substr(-2)).toString()}function openNav(){$("#mySidenav").css("width","250px")}function closeNav(){$("#mySidenav").css("width","0")}function updateOverView(e,a){handleEvseAPI(a.ACTUAL_CONFIG_CURRENT,a.ACTUAL_OUTPUT_CURRENT,a.EV_STATE),$("#maxCurrent").text(a.ACTUAL_CONFIG_CURRENT),$("#power").text(rnd(e.P1+e.P2+e.P3,1e3,1)),$("#energy").text(rnd(e.P1+e.P2+e.P3,1e3,2)),powerAVGchartData=e.Pm,hourEnergyData=e.Es,dailyEnergyData=e.D,$("#duration").text(a.DURATION),$("#user").text(a.USER),dotControl()}powerAVGchartData=0,hourEnergyData=[],dailyEnergyData=[],monthlyEnergyData=[],selectedEnergy="hourly",powerGraph="undefined",energyBarGraph="undefined",energyPieGraph="undefined",timer=0,$(function(){$("div.mainContainer").load("overview",function(){new evse(1).createEvseGauge(),new Overview,$.ajax({url:"/updateData"}).done(function(e){$.ajax({url:"/updateEvse"}).done(function(a){updateOverView(e,a),$(".loader").hide(100)})}),timer=setInterval(function(){$.ajax({url:"/updateData"}).done(function(e){$.ajax({url:"/updateEvse"}).done(function(a){updateOverView(e,a)})})},2e3)}),$("#mySidenav a").click(function(e){"overview"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("overview",function(){$("#sideText").text("☰ Overview"),new evse(1).createEvseGauge(),handleEvseAPI(0,0,0),new Overview,$.ajax({url:"/updateData"}).done(function(e){$.ajax({url:"/updateEvse"}).done(function(a){updateOverView(e,a)})}),timer=setInterval(function(){$.ajax({url:"/updateData"}).done(function(e){$.ajax({url:"/updateEvse"}).done(function(a){updateOverView(e,a)})})},2e3)})):"data"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("datatable",function(){$("#sideText").text("☰ Data"),new CreateDataTable,updateData(),timer=setInterval(function(){updateData()},2e3)})):"rfid"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("rfid",function(){$("#sideText").text("☰ Rfid"),new RfidContext,$.ajax({url:"/updateRFID"}).done(function(e){new CreateRfidList(e)})})):"settings"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("settings",function(){$("#Lw").text("Wi-Fi scanning"),$(".loader").show();var e=new Setting;e.refreshSetting(),e.refreshWifiClient(),evseInstanceGauge="undefined",$("#sideText").text("☰  Settings"),$("#refreshSSID").append('<span class="spinner-border spinner-border-sm"></span>')})):"powerChart"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("powerChart",function(){evseInstanceGauge="undefined","undefined"!=powerGraph&&powerGraph.destroy(),$("#sideText").text("☰  Power chart");var e=new powerChart(refreshPowerChart),a=$("#powerGraph"),t=e.getConfig();powerGraph=new Chart(a,t),timer=setInterval(function(){$.ajax({url:"/updateData"}).done(function(e){$("#updateData").html(e.datalayer),powerAVGchartData=e.Pm,dotControl(),refreshPowerChart()})},5e3),loadPowerChart()})):"energyChart"==$(this).attr("id")&&(clearTimeout(timer),$("div.mainContainer").load("energyChart",function(){evseInstanceGauge="undefined",$("#sideText").text("☰  Energy charts");var e=new energyChart("","Hourly E [Wh]","Wh");o=$("#barEnergy"),d=e.getConfig(24),energyBarGraph=new Chart(o,d),energyBarGraph.getDatasetMeta(1).hidden=!0,selectedEnergy="daily",updateData(),timer=setInterval(function(){$.ajax({url:"/updateData"}).done(function(e){$("#updateData").html(e.datalayer),hourEnergyData=e.Es,dailyEnergyData=e.DailyEnergy,monthlyEnergyData=e.MonthlyEnergy,"hourly"==selectedEnergy?refreshEnergyChartHourly():"daily"==selectedEnergy?refreshEnergyChartDaily():"monthly"==selectedEnergy&&refreshEnergyChartMonthly(),dotControl()})},2e4),refreshEnergyChartHourly()}))}),$(document).on("click","#synchroTime",function(){$("#synchroTime").append('<span class="spinner-border spinner-border-sm"></span>'),e=getTime(),e&&$.ajax({type:"POST",url:"/updateData",async:!0,data:JSON.stringify({time:e}),success:function(e){$("#updateData").html(e.datalayer),$("#synchroTime").find("span").remove()}})}),$(document).on("click","#relay",function(){e=1,e&&$.ajax({type:"POST",url:"/updateData",async:!0,data:JSON.stringify({relay:e}),success:function(e){$("#updateData").html(e.datalayer),1==e.process?($("#RELAY").text("ON"),$("#RELAY").css("color","#74DF00")):($("#RELAY").text("OFF"),$("#RELAY").css("color","#FF0000"))}})}),$(document).on("click","#hourE",function(){selectedEnergy="hourly",energyBarGraph.clear(),energyBarGraph.destroy();var e=new energyChart("","Hourly E [Wh]","Wh");o=$("#barEnergy"),o.height("75vh"),d=e.getConfig(24),energyBarGraph=new Chart(o,d),energyBarGraph.getDatasetMeta(1).hidden=!0,refreshEnergyChartHourly()}),$(document).on("click","#dayE",function(){selectedEnergy="daily",energyBarGraph.clear(),energyBarGraph.destroy();var e=new energyChart("","Daily E [kWh]","kWh");o=$("#barEnergy"),o.height("75vh"),d=e.getConfig(31),energyBarGraph=new Chart(o,d),energyBarGraph.getDatasetMeta(1).hidden=!0,refreshEnergyChartDaily()}),$(document).on("click","#monthE",function(){selectedEnergy="monthly",energyBarGraph.clear(),energyBarGraph.destroy();var e=new energyChart("","Monthly E [kWh]","kWh");o=$("#barEnergy"),o.height("75vh"),d=e.getConfig(12),energyBarGraph=new Chart(o,d),energyBarGraph.getDatasetMeta(1).hidden=!0,refreshEnergyChartMonthly()})});